'use strict';
var gymalaya = angular.module('gymalaya.controllers',['gymalaya.services']);

var controllers={};

////////////////////////////////////////////////
////			Workout controller  		////
////////////////////////////////////////////////
controllers.workoutCtrl = function ($scope, $http, $rootScope, $location, General, login) {
	$scope.modifyBar = true;
	$scope.dirty = [];
	$scope.backEnabled = false;

	$http.get(General.baseUrl + '/workouts')
	.success(function(data) {
		$scope.workouts = data;
	}).error(function(data, status, headers, config) {
		alert(data);
	});


	$scope.modify = function(){
		if(!$scope.modifyBar){
			for (var i = 0; i < $scope.workouts.length; i++) {
				if ($scope.dirty.indexOf($scope.workouts[i]._id)!=-1){
					(function(workoutId,newName){
						$http.put(General.baseUrl + '/workout/' + workoutId,{name:newName})
						.error(function(data, status, headers, config) {
							console.log(data);
							alert(data);
						});
					})($scope.workouts[i]._id,$scope.workouts[i].name);
				}
			}

			$scope.dirty=[];
		}

		$scope.backEnabled = !$scope.backEnabled;
		$scope.modifyBar = !$scope.modifyBar;
	};

	$scope.changeWorkout = function(workout){
		if ($scope.dirty.indexOf(workout._id)==-1){
			$scope.dirty.push(workout._id);
		}
	};

	$scope.deleteWorkout = function(workout){
		$http.delete(General.baseUrl + '/workout/' + workout._id)
		.success(function(data) {
			General.filterArr($scope.workouts, workout, "_id");
		}).error(function(data, status, headers, config) {
			console.log(data);
			alert(data);
		});
	};

	$scope.addWorkout = function(){
		$http.post(General.baseUrl + '/workout',{name:""})
		.success(function(data) {
			$scope.workouts.push(data);
		}).error(function(data, status, headers, config) {
			console.log(data);
			alert(data);
		});
	};

	$scope.showWorkout = function(workout){
		$location.path('/exercise/' + workout._id);
	};

	$scope.addIndicator = function(){
		$scope.weight=null;
		$("#weightModal").modal({backdrop:false});
	};

	$scope.addPic = function(){
		if ($scope.weight){
			$("#weightModal").modal('hide');
			navigator.camera.getPicture(function(imageURI){
				$scope.upload(imageURI, $scope.weight);
			}, function(message){
				alert(message);
			}, {quality: 50,destinationType: Camera.DestinationType.FILE_URI,encodingType: Camera.EncodingType.JPEG}); 
		}
	};

	$scope.upload = function(imageURI, weight){
		var ft = new FileTransfer();
        var options = new FileUploadOptions();

        options.fileKey = "file";
        options.fileName = new Date().getTime() + '.jpg'; // We will use the name auto-generated by Node at the server side.
        options.mimeType = "image/jpeg";
        options.chunkedMode = false;
        options.params = { // Whatever you populate options.params with, will be available in req.body at the server-side.
            weight: weight
        };

        ft.upload(imageURI, General.baseUrl + '/indicator',function (e) {
        },function (e) {
        	console.log(e);
            alert("Upload failed");
        }, options);
	};

	$scope.logout = function(){
		localStorage.setItem("username",null);
		$rootScope.user=null;
		$location.path("/login");
	};

	$scope.back = function(){
		$location.path("/workout");
	};
};

////////////////////////////////////////////////
////			Login controller  			////
////////////////////////////////////////////////
controllers.loginCtrl = function ($scope, $location, $http, $rootScope, General) {
	$scope.login = function(){
		localStorage.setItem("username", $scope.username);

		General.loggedIn($scope.username,function(verified){
			if (verified){
				$location.path('/workouts');
			}else{
				alert("User not found");
			}
		});
	};
};

////////////////////////////////////////////////
////			Exercise controller  		////
////////////////////////////////////////////////
controllers.exerciseCtrl = function ($scope, $http, $routeParams, $location, $route, $rootScope, General, login) {
	$scope.modifyBar = true;
	$scope.dirty=[];
	$scope.backEnabled = true;
	$scope.mgroups = [];

	$http.get(General.baseUrl + '/exercises/' + $routeParams.workoutId)
	.success(function(data) {
		$scope.exercises = data;
	}).error(function(data, status, headers, config) {
		console.log(data);
		alert(data);
	});

	$http.get(General.baseUrl + '/mgroups')
	.success(function(data) {
		$scope.mgroups = data;
	}).error(function(data, status, headers, config) {
		console.log(data);
	});

	$scope.modify = function(){
		if(!$scope.modifyBar){
			for (var i = 0; i < $scope.exercises.length; i++) {
				if (!$scope.exercises[i]._id){
					(function(exercise){
						$http.post(General.baseUrl + '/exercise',exercise)
						.success(function(data) {
							exercise = data;
						}).error(function(data, status, headers, config) {
							console.log(data);
							alert(data);
						});
					})($scope.exercises[i]);
				}else if ($scope.dirty.indexOf($scope.exercises[i]._id)!=-1){
					(function(exercise){
						$http.put(General.baseUrl + '/exercise/' + exercise._id, exercise)
						.success(function(data) {
							exercise=data;
						}).error(function(data, status, headers, config) {
							console.log(data);
							alert(data);
						});
					})($scope.exercises[i]);
				}
			};
			$scope.dirty=[];
		}

		$scope.modifyBar = !$scope.modifyBar;
	};

	$scope.deleteExercise = function(exercise){
		if(!exercise._id){
			$scope.exercises.splice($scope.exercises.indexOf(exercise),1);
		}else{
			$http.delete(General.baseUrl + '/exercise/' + exercise._id)
			.success(function(data) {
				General.filterArr($scope.exercises, exercise, "_id");
			}).error(function(data, status, headers, config) {
				console.log(data);
				alert(data);
			});
		}
	};

	$scope.changeExercise = function(exercise){
		if((exercise._id) && ($scope.dirty.indexOf(exercise._id)==-1)){
			$scope.dirty.push(exercise._id);
		}
	};

	$scope.openMgroups = function(){
		$("#mgroupModal").modal({backdrop:false});
	};
	$scope.addExercise = function(mgroup){
		$("#mgroupModal").modal('hide');
		$scope.exercises.push({workout:$routeParams.workoutId,sets:3,repetitions:10,weight:20,mgroup:mgroup._id});
	};

	$scope.updateSet = function(exercise, number){
		exercise.sets+=number;
		$scope.changeExercise(exercise);
	};

	$scope.updateRep = function(exercise, number){
		exercise.repetitions+=number;
		$scope.changeExercise(exercise);
	};

	$scope.updateWeight = function(exercise, number){
		exercise.weight+=number;
		$scope.changeExercise(exercise);
	};

	$scope.logout = function(){
		localStorage.setItem("username",null);
		$rootScope.user=null;
		$location.path("/login");
	};

	$scope.back = function(){
		if ($scope.modifyBar){
			$location.path("/workout");
		}else{
			$route.reload();
		}
	};
};


gymalaya.controller(controllers);